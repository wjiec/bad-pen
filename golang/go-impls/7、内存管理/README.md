内存管理
---

内存管理是运行时的另一部分，主要负责应用程序如何申请、分配和回收内存，尤其是栈上和堆中的内存都是如何被管理和分配的。



### 内存分配器

内存空间包含两个重要区域：栈区和堆区。函数调用的参数、返回值以及局部变量大都会被分配到栈上，**由编译器负责管理**。堆中的对象**由内存分配器分配并由垃圾收集器回收**。

#### 分配原理

Go 语言的内存分配器借鉴 TCMalloc 的设计实现高速内存分配，其核心理念是使用多级缓存将对象根据大小分类，并按照类别实施不同的分配策略。

内存分配器不仅会区别对待大小不同的对象，还会将内存分成不同等级分别管理。内存分配器引入线程缓存（thread cache）、中心缓存（central cache）和堆（heap）3 个组件分级管理内存。

#### 稀疏内存

使用稀疏内存布局不仅能移除堆大小的上限，还能解决 C 语言和 Go 语言混合使用时的地址空间冲突问题。不过基于稀疏内存的内存管理失去了内存连续性这一假设，使得内存管理变得更加复杂。

#### 内存管理组件

内存管理中有几个重要的组件：`runtime.mspan`、`runtime.mcache`、`runtime.mcentral`、`runtime.mheap`。

##### mspan

mspan 是 Go 语言内存管理的基本单元，该类型是一个双向链表实现。每个 mspan 都管理 npages 个页（8kb 大小），当结构体管理的内存不足时，运行时会以页为单位向堆申请内存。

##### mcache

mcache 是 Go 语言中的线程缓存，它会与线程上的处理器一一绑定，主要用来缓存用户程序申请的微小对象。在 mcache 中还包含了用于分配微小对象的分配器，专门管理 16 字节以下的对象。

##### mcentral

Mecntral 是内存分配器的中心缓存，与线程缓存不同，访问中心缓存中的内存管理单元需要使用互斥锁。

##### mheap

mheap 是内存分配的核心数据结构，Go 语言程序会将其作为全局变量存储，堆中初始化的所有对象都是由该结构体统一管理的。

