云原生软件平台
----------------------

云原生平台会提供一套服务来满足之前提到的需求，即**软件能够持续部署、高度分布式，以及在不断变化的环境中运行**。尽管云原生软件定义了许多新的模式和实践，但是**开发人员和运维人员都不需要提供所有这些功能**。云原生平台（旨在支持云原生软件的平台）已经提供了丰富的功能来支持现代软件的开发和运行。

### 云原生平台的发展

正如需要新架构来满足现代软件的需求一样，也**需要新的平台来支持相应的新的开发和运维实践**。

#### 从云计算开始

在云的早起发展阶段，更多的只是**提供计算能力**。开发人员和运维人员不再需要购买和管理他们自己的硬件，而是可以通过自助式的服务界面，在很短时间内获得所需要的资源（SaaS）。

>**IaaS**：基础设施即服务，一个提供访问基础设施（主机，存储和网络）的接口。
>
>**云原生平台**：一个让应用程序成为开发人员或运维人员最主要的交互对象的接口。

#### 云原生的初现

开发人员和运维人员真正关心的是，**提供用户服务的系统是否正常运行**。而云原生平台承担了以前由运维人员承担的一部分工作。

虚拟化的基础设施使计算、存储和网络抽象的使用变得更加容易，从而将底层硬件的管理留给了IaaS服务商。云原生平台进一步提高了抽象程度，**允许用户更加轻松地调用操作系统和中间件的资源**，并且将底层计算、存储和网络的管理留给了基础设施服务商。

### 云原生平台的核心原则

云原生平台所基于的哲学基础是**让那些高度分布式的应用程序可以在不断变化的环境中运行**。

#### 容器

**容器是云原生软件的重要推动者**。容器的流行无疑是被云原生应用程序的支持需求驱动的，而容器的出现也同样推动了云原生软件的发展。

**容器其实就是一个使用底层机器功能（操作系统）的计算环境**。一台机器上可以运行多个容器，它们之间彼此隔离。容器比虚拟机更加轻量化，创建容器的时间比创建虚拟机的时间低几个数量级，消耗的资源也更少。

#### 支持不断变化

云原生平台可以配置为使用多个可用区，然后**由平台来编排跨可用区的所有应用程序实例**。平台实现可以将人们从这些工作中解放出来，当环境发生变化时，应用程序还可以继续工作。

“**最终一致性**”是云计算中的一个关键模式，**系统管理通过不断监控系统的实际状态，将其与期望装修进行比较，并在必要时进行调整来实现预期**。

#### 支持高高度分布式

所有对自治的讨论都包含两部分：

* **团队自治**：可以让团队避免烦冗的流程和大量协调工作，快速迭代和部署应用程序。
* **应用程序自治**：在应用程序自己的环境中运行多个微服务，同时支持独立开发并降级级联失败的影响。

随之而来的是一个由分布式组件组成的系统，而非原来单个组件或者单个进行的架构，因此需要面临的复杂性也是前所未见的。所幸的是，开发人员并不需要负责实现云原生软件的所有模式，这些模式将由平台来实现。

##### 服务发现

单独的服务运行在不同的容器和不同的主机上，为了让一个服务能够调用另一个服务，它必须首先能够**找到另一个服务**。

##### 配置服务

为了在配置更新时**每个实例都能得到更新的配置信息**，由于软件是分布式的，所以云原生平台需要提供配置服务这个功能。

##### 云原生平台提供的其他服务

* **分布式链路追踪**：允许自动将跟踪器嵌入到请求中，以诊断多个微服务调用之间的问题。
* **断路器**：防止意外产生的内部DDoS攻击（重试风暴）。

### 人员分工

云原生平台可以帮助完成更多的任务：**安全性、合规性、变更控制、多租户以及控制部署过程**。

云原生平台和软件之间的边界是一个合约，规范了如何提供软件（通过平台提供的API），以及平台需要保证软件良好运行的各项服务级别。建立这些边界和合约有助于实现一个强大的功能，允许组建多个独立的团队：

* 其中一个软对负责配置云原生平台，提供企业所需要的服务级别（团队成员需要知道如何使用基础设施的资源，了解云原生平台的内部工作方式，以及知道如何对平台进行微调）。
* 另一个团队或者几个团队是为最终用户构建、运行和维护软件的应用程序团队。
  * 每个软对负责的模块不重叠。这非常重要，这是平台能够支持更加频繁的部署的主要原因之一。
  * 每个团队“拥有”一个具体负责的产品，以及这个产品的整个生命周期。

有了正确的合约之后，应用程序团队和平台团队都是自治的。每个团队都可以在不与其他团队进行大量协调的情况下，完成自己所负责的任务。为了达到最佳的运维体验，**平台必须禁止碎片化的变化，让团队形成自治，并同时保证安全、合规和其他方面的控制**。

### 云原生平台的其他功能

#### 云原生平台支持整个软件开发生命周期

**只有实现部署到生产这个过程的自动化，才能实现持续交付**。对于从开发阶段开始的持续交付过程来说，**保证环境的一致性是绝对必要的**。而云原生平台就是一个定义和管理这些环境的地方。

只有当平台提供了含有正确抽象能力的环境以及一个可以进行自动化交互的API时，从软件开发到投入生产的整个过程才能成为一个可控且高效的流水线。

#### 安全性、变更控制和合规性（管控功能）

我们必须认识到管控流程所带来的价值：保护客户的个人数据、避免可能会导致关键业务停机的变更。这些都需要感谢现有的，避免出现全面性生产失误的保障措施。这些流程存在的问题不在于人，也不在于人所在的企业。而是**因为犯错误的可能性实在太大了**。

#### 控制进入容器的手段

通过利用**容器技术**，我们可以将**运行时环境控制、可部署控件控制和部署过程控制直接引入平台**，从而实现所需的安全、合规和变更控制的保障，从而实现可重复性。**如果控制了一组基础镜像，那么就可以完全控制程序的许多安全特性**。**使基础镜像尽可能小确实是一种最佳实践，使攻击面更小会让系统更加安全**。

**将应用程序团队的关注点与平台团队的关注点分开的架构**：应用程序团队负责交付支持业务的数字产品，平台团队负责满足企业对安全和合规的要求。同时应用程序团队只负责提供应用程序，而平台团队负责提供其他的一切。

#### 升级与安全漏洞修补

应用程序容器的任何部分需要更新时，我们不需要去修改正在运行的实例，我们可以直接新部署一组含有新组件的容器。这种升级的基本模式（**滚动升级**）是：

1. 关闭和销毁一组应用程序实例
2. 启动同等数量的新容器实例
3. 当他们启动并运行正常之后，继续替换下一批旧实例

当平台团队所提供的容器由部分更新时，可以创建一个新的容器；如果应用程序团队有新的版本，会创建并部署一个新的容器。这种**自治**对于数据中心的补丁管理非常重要，当发现某个新的漏洞时，我们需要快速打补丁，而不是在所有应用程序之间进行复杂的协调。

#### 变更控制

**变更控制功能是防止在生产环境中发生变更的最后防线**。云原生平台允许以一种完全不同的方式解决变更控制的问题。**它提供了相互隔离组件的办法，这样即使某个部分出现问题，也不会影响其他部分。**

基于容器的方案已经被证实是一个出色的解决方案：基于**控制组**（cgroup，控制对共享资源的使用）和**命名空间**（namespace，控制共享资源的可见性），Linux容器已经成为云原生软件各种微服务的执行环境。

**相互隔离**的实体被称为**租户**（tenant）。而平台所提供的访问控制、监控、路由等功能必须支持多租户。
