在生成环境中运行云原生应用程序
----------------------------------------------

将软件部署到生产环境的过程是十分有挑战性的。有些流程本意是为了**降低风险和提高效率**，但无意中却起到了相反的效果，因为其过程又慢又麻烦。在部署后，**保持应用程序的正常运行**也同样困难。

如今生产环境变得如此脆弱的原因并不在于任何特定的团队或者个人，“罪魁祸首”是**整个行业中几乎无处不在的一系列企业行为和运营实践**。

解决方案是**设计一个不把生产环境运维看作一个孤立的行为，而是将软件开发的实践和架构模式与在生成环境中部署和管理软件的活动联系起来**的新系统。



### 部署云原生应用程序所面临的困难

我们所面临的挑战在于不经意间设置了一系列阻碍成功的行为方式。尽管面临的每个挑战都不同，但几乎所有企业都存在一个常见问题。

![导致软件难以部署和无法在生产环境保持良好运行的原因](../assets/figure_2-1.jpg)

* 碎片化的变化：**在软件开发生命周期中存在不断出现的变化**，不仅会对初次部署造成影响，还会影响应用程序后续的稳定性。最终会导致部署的软件与部署环境之间存在着不一致性。
* 有风险的部署：部署在复杂网络中的**某个组件如果发生了变化，可能会引起系统的其他部分出现连锁反应**，从而导致风险。风险的恐惧感会产生下游反应，降低后续部署的频率。
* 认为变化是例外：希望软件底层依赖的系统是稳定的这种想法是不靠谱的。**基础架构的任何不稳定都会影响到正在运行的应用程序**，这会使得应用程序难以保持正常的运行状态。
* 生产环境的不稳定性：生**产环境自身的不稳定性**通常会带来更多的麻烦，最终限制生产环境的部署频率。

#### 碎片化的变化

在软件开发生命周期中通常会有两个方面会不断发生变化：

* **环境发生变化**：常见的例子时所部署软件的依赖包存在差异，或者是服务器系统配置存在差异。
* **部署的构件发生变化**：任何对可部署构件的重新编译或者重新打包都可能而且经常地引入其他的差异（配置文件的修改，或者所依赖的库文件等）。

#### 有风险的部署

为了应对部署的风险，一般的做法是创建大量的工具和流程来减少部署的风险。这种做法的核心在于**通过大量的前期工作来减少失败的可能性**。

这种做法会导致发布的频次变低，而**低频次的发布会导致每次部署包含更多的变更，也会对系统其它部分造成更多的影响**。

#### 认为变化是例外

在业务中**唯一的不变就是变化**，对于云环境上的系统来说，它们都将持续经历不稳定和变化。

#### 生产环境的不稳定性

生成环境自身的不稳定进一步增加了部署的难度。将应用程序部署到一个已经不稳定的环境是不明智的。相对稳定的环境是进行部署的先决条件。



### 解决办法

解决问题的办法是使用CICD（Continuous Integration, Continuous Delivery/Deployment，持续集成，持续交付/部署）这个新的IT运维模型。将其作为主要的驱动力量，重新设计整个软件开发声明周期的流程。这样可以显著简化部署过程，并为整个系统带来很多好处。

![围绕CICD打造一个有效、可预测、文档的系统](../assets/figure_2-2.jpg)

#### 持续交付

频繁发布能够给业务带来**更好的敏捷性和可实施性**，这两者都是衡量一个企业是否强大的标志。

持续交付**并不意味着将每次的代码更改都部署到生产环境中**，它意味着**在任何时候都可以部署一个尽可能新的软件版本**。开发团队每添加一个功能都会经过一个完整的测试流程（自动化的），并将代码打包，从而**确保软件已经准备好了部署**。

传统的开发模式中，前期会有大量的开发工作和长时间的测试流程。而何时进行下一次软件发布依赖于商业决策，而不是由一个复杂、不可预测的软件开发过程决定。我们可以将“准备就绪”的软件版本提供给客户，从而有机会收集反馈，并用来改进或者变更产品的后续版本。

在软件开发过程中我们**总是没有办法正确预估开发所需的时间**，或是需要更激进的时间计划，或是出现了意想不到的挑战。这时候我们可以做出的选择一是坚持计划的发布时间，从而压缩测试阶段的时间，代价就是牺牲软件的质量。二是保持软件的质量标准而推迟发布日期。

**总的来说，漫长的发布流程会给软件交付过程带来巨大的风险，业务部门缺少控制何时将产品发布到市场的能力，而企业则常常处于既要面对短期市场压力，又要实现提高软件资料、增强软件功能这一长期目标的两难境地。而快速迭代为系统释放了大量的压力，使得业务部门可以决定何时以及如何将产品推向市场。**

#### 可重复性

碎片化的变化会对软件开发造成不利影响。为了适应各个部署环境之间、部署构件之间的差异，部署的过程会变得非常困难。这些不一致使系统在生成环境中保持正常云运行变得非常困难。

如果无法可靠地地复现故障时的环境和配置，系统的稳定性就会一直无法保证。而解决办法就是实现**可重复性**。可重复性可以带来两个巨大的好处：**有助于系统部署和保证系统的稳定性**。为了实现所需的可重复性，具体来说需要做到以下几点：

* 控制部署软件的环境
* 控制正在部署的软件
* 控制部署流程

##### 控制部署软件的环境

在软件中，需要通过两个主要机制来让系统的运行环境保持一致：

* 必须从标准化的机器镜像开始（在构建环境的过程中，必须始终从一个已知的起点开始）
* 为了部署软件而对基础镜像镜像的更改，也必须通过编程的方式来实现。

这个流程一旦建立，之后**对环境的任何更改也必须按照同样的方式进行**。如果有运维人员通过SSH进入服务器更改配置，那就违背了严格管理环境的原则。可以在有人通过SSH进入时，服务器就会自动下线（保证进入只是为了检查问题，而不允许修改运行中的环境配置）。或者干脆直接禁用SSH。

需要认识到的是：**环境之间总是有差异的**（比如数据库等依赖服务的配置）。

##### 控制正在部署的软件

一般情况下我们不会将配置信息直接硬编码到代码中，而是提取代码中的参数，并将这些值放到某种类型的属性文件中。但是当部署时，修改了配置文件的内容就会给可重复性造成影响。控制软件变更的基本原则就是**确保软件之间唯一的区别是属性文件的内容**。

***这可以在配置中不包含任何具体的环境，而是从另外的属性来源加载。或者直接在软件中配置所有环境的属性，通过命令行参数来选择一个正确的环境。***

##### 控制部署流程

保证了环境的一致性，以及创建了一个可以贯穿整个软件开发生命周期的可部署软件后，剩下的就是要确保这些部分以可控、可重复的方式组合在一起。而能确保一致性的唯一方式就是使用**自动化**。

#### 安全部署

企业用来控制部署上的风险的最常见手段就是**通过复杂、缓慢的流程和耗时的测试**来进行管理。诞生于云计算时代的软件公司有一种全新的方式：**直接在生产环境中进行试验**。

在生产环境中进行试验的重点在于，有合适的“安全网”。而安全网指的则是：**所有的软件设计和运维实践，都是为了在必要时可以轻松、快速地在试验中回退，并返回到之前已知的工作状态上**。

在这种新的方式中，因为已经预料到可能会失败，所以会特意提前给自己准备一条降低失败影响的退路。这会**让部署过程变得更简单、更快速，并且让系统在上线运行后具有更好的稳定性**。要实现安全部署，有三个紧密相关的部分：

* 并行部署和版本化的服务
* 进行必要的指标监控
* 灵活的路由功能

##### 并行部署和版本化的服务

安全部署的核心是并行部署。与用新版本完全替换一个正在运行的软件版本不同，完全可以在部署新版本的同时让已有的版本继续运行。如果一切顺利，那么就可以继续将更多流量路由到新的版本上。任何时候一旦出现了问题，都可以快速地将流量切回到以前的版本。

*软件必须实现版本控制，而且版本必须对路由可见，以便恰当地切分流量。而且所有的指标监控也必须与软件的版本相关联，以便后续进行对比。*

##### 进行必要的指标监控

用于查看分析新版本工作情况的指标有多种形式：

* 完全独立于任何实现细节：请求、响应时间和时延等
* 正在运行的进程的指标：使用的线程数，已使用的内存等
* 业务相关的指标：每比交易的金额、用户查看商品的次数等

在数据采集和监控过程中，**数据指标的可用性**是首要考虑的问题。

##### 灵活的路由功能

**路由是实现并行部署的关键因素**，而路由算法属于软件的一部分。简单的实现可以是按照百分比进行流量切分，而有时可能需要根据用户的所在位置或者某部分用户开放。

#### 变化是一定的

“环境变化都是由我们人为、有意识得造成的”这种假设性的运维模型是行不通的。我们需要放弃去“完成”一件任务（解决意外）的想法。

事物总在变化，所以与其去应对它，不如去拥抱它。在设计软件架构时就考虑到变化情况，让系统能不断地将实际情况与期望状态进行比较，当出现偏差时，系统可以自动修复问题使实际情况回到期望情况上。

**我们的目标是以一种*让系统自我修复并适应不断变化*的方式，来设计和构建整个系统。**

一个能在不断变化的情况下保持系统功能的完整性，是我们设计软件的最终目标。一个能不断自我修复的系统可以极大地简化部署过程并降低风险。坚持“**变化是一定的**”的思维模式，可以从根本上改变在生产环境中管理软件的方式。

