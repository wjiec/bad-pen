计算资源管理
-------------------

为一个Pod配置资源的预期使用量和最大使用量是Pod定义中的重要组成部分。这有助于确保Pod可以公平地使用Kubernetes集群资源，同时也会影响整个集群Pod的调度。



### 为Pod中的容器申请资源

我们创建一个Pod时，可以指定容器对CPU和内存的资源请求量（`resources.requrest`）和资源限制量（`resources.limits`）。这些属性是针对每个容器单独指定，Pod对资源的请求量和限制量是它所包含的所有容器的请求量和限制量之和。

#### 创建包含资源请求的Pod

我们可以通过在命令行中带上`--requests=‘cpu=100m,memory=32Mi’`的方式创建Pod，也可以通过YAML文件方式

```yaml
kind: Pod
apiVersion: v1
metadata:
  name: container-res
spec:
  containers:
    - name: app
      image: laboys/http-whoami
      resources:
        requests:
          cpu: 100m
          memory: 32Mi
```

以上我们请求了1/10核的CPU和32MB的内存，这表示我们预期这个容器最大会消耗0.1核CPU和32M内存（这里只是预期，实际上是可以超出的，可以理解为**预留资源**）。需要注意CPU和内存申请量上有一些小规定

* CPU：如果是数字N（可以是浮点数）则表示申请N核的资源，如果是XXXm则表示申请XXX / 1000核的资源
* Memory：如果后缀`Ki、Mi、Gi`则表示是以2为幂（1024进位），如果后缀是`k、M、G`等则表示以10为底（1000进位）

#### 资源请求如何影响调度

调度器在调度时并不关注各类资源在当前时刻的使用量（实际使用量），而只关心节点上已经部署的所有Pod申请的资源量之和。调度器会根据节点所剩下的资源是否能够当前Pod的需求而决定是否将Pod调度到这个节点上。

我们可以通过`kubectl describe nodes`来查看节点的资源占用和总量。**需要注意的是，有些资源会为Kubernetes或者系统组件预留。**

##### 调度器如何利于Pod request为其选择最佳节点

在之前我们学习到调度器首先会比节点列表进行过滤，排除那些不满足要求的节点，然后根据预先配置的优先级函数对其他节点进行排序。其中有两个基于资源请求量的排序函数：

* `LeastRequestedPriority`：将Pod调度到拥有更多未分配资源的节点上（更加平衡）
* `MostRequestedPriotity`：将Pod调度到拥有最少未分配资源的节点上（更加紧凑，适合在云服务平台自动伸缩节点时节约成本）

当Pod因为资源不足无法被调度到节点上而进入`Pending`状态时，我们可以通过删除一些Pod让节点资源被释放，当资源满足要求后，Pod将会被调度。

#### CPU requests如何影响CPU的时间分配

CPU requests不仅在调度时起作用，它同时还决定着剩余（未使用）的CPU时间将会按照`requests.cpu`的比例进行分配

> 节点上共有2000m的CPU资源，此时A申请200m，而B请求800m，机器上剩余的1000m在则会按照1:4分配给A和B。

需要注意的是，如果此时有容器正处于空闲状态，则其他的容器是可以占用全部的CPU资源的。只有当所有容器都需要跑满CPU时才会按照比例进行分配时间片。

#### 定义和申请自定义资源

Kubernetes允许用户未节点添加属于自己的自定义资源，同时支持在Pod requests里申请这种资源。一个自定义资源的好例子是机器上的GPU单元数量。



### 限制容器的可用资源

