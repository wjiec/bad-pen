.PHONY: codegen

GO_MODULE = github.com/wjiec/programming_k8s/sample-controller

codegen:
ifdef DOCKER_HOST
	@$(eval VOLUME_NAME=$(shell bash -c 'head --bytes 4 /dev/random | hexdump -e "/1 \"%02x\""'))
	@docker volume create $(VOLUME_NAME)
	@docker container create --name $(VOLUME_NAME) -v $(VOLUME_NAME):/code busybox
	@docker cp . $(VOLUME_NAME):/code
else
	$(eval VOLUME_NAME=$(PWD))
endif

	docker run -ti --rm -v $(VOLUME_NAME):/go/src/$(GO_MODULE) -e GOPROXY=https://goproxy.cn,direct kube-gen \
		--pkg-root $(GO_MODULE)/pkg

ifdef DOCKER_HOST
	@docker cp $(VOLUME_NAME):/code/pkg .
	@docker rm $(VOLUME_NAME)
	@docker volume rm $(VOLUME_NAME)
endif

clean:
	find $(PWD) -type f -name "*.go" | xargs grep -l -E '^// Code generated by \w+-gen. DO NOT EDIT.$$' | xargs rm
	find $(PWD) -type d -empty -delete
