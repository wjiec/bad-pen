Kubernetes 编程
---

Kubernetes 编程是指开发云原生 Kubernetes 应用，这类应用通过与 API 服务器进行交互，直接查询、更新资源的状态。



### 控制器

控制器实现了一个控制循环，它通过 API 服务器观测集群中的共享状态，进行必要的变更，尝试将当前状态转换到期望的状态。

一个控制器通常会使用以下的数据结构：

* `Informer`：负责观察资源的目标状态，这个过程需要是可伸缩和可持续的
* `workqueue`：事件处理器把状态变化情况放入工作队列，用于保证在必要时可以进行重试。

#### 事件

Kubernetes 的控制平面重度依赖事件处理和松耦合的组件架构。事件都是通过 Watch 机制在控制器内部从 API 服务器发向 Informer，也就是流式发送的 Watch 事件。

#### 边沿触发和水平触发

检测状态变化（也就是产生事件）有两种基本的方法：

* 边沿触发：当状态发生变化时，触发一个处理器动作
* 水平触发：定期检查状态，如果某种特定的条件满足就触发一个处理器动作

单独使用边沿触发或水平触发都不足以应对事件丢失或同步问题，所以 Kubernetes 的控制器会采用**边沿触发➕定期的重新同步**策略来处理这些问题。

#### 改变集群对象或外部系统状态

在这个阶段，控制器会改变它所管理的对象的状态。“改变资源状态”并不意味着这个资源必须是 Kubernetes 集中中的一部分，也可以是外部的资源。

#### 乐观并发

所谓乐观并发就是通过对比修改时的资源版本号来确定是否发生了冲突（版本号不匹配），如果发生了冲突，则 API 服务器会拒绝不匹配的修改请求，由客户端（控制器、调度器或 kubelet）来处理这种冲突，比如重试一次。

对于控制器来说，遇到冲突的场景完全是预期之内的，所以必须正确面对冲突的场景并正常对其进行处理。